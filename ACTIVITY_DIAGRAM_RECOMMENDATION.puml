@startuml
title Hệ thống gợi ý sản phẩm E-commerce - Training & Inference

skinparam activity {
  BackgroundColor #FFFFFF
  BorderColor #333333
  FontSize 10
}
skinparam partition {
  BorderColor Black
  FontStyle bold
  FontSize 11
}

' =========================
' TRAINING PIPELINE (OFFLINE)
' =========================
partition "TRAINING (OFFLINE)" {
  start
  :Thu thập dữ liệu\n(interactions, products, ratings, context);
  :Tiền xử lý\n(LabelEncoder, tính n_users/n_items/n_contexts);
  :Chia dữ liệu\nTrain 80% / Test 20%;
  :Tạo Dataset & DataLoader;
  :Khởi tạo 4 mô hình\nENCM, LNCM, NeuMF, BMF;
  
  repeat
    :Training Loop\nForward → Loss → Backward → Update weights;
  repeat while (Còn epoch?) is (Có)
  
  :Đánh giá mô hình\n(Precision@10, MAP@10, AUC, RMSE);
  :Chọn mô hình tốt nhất;
  :Lưu mô hình\n(Weights .h5, Config JSON, Encoder pickle);
  :Lưu encoder vào CSDL;
  stop
}

' =========================
' INFERENCE PIPELINE (ONLINE)
' =========================
partition "INFERENCE (ONLINE - REALTIME)" {
  start
  :User gửi yêu cầu\n(userId, limit);
  :Backend xử lý\n/api/recommendations/list;
  
  if (Có cache không?) then (Có)
    :Trả về kết quả từ cache;
    stop
  else (Không)
    :Lấy dữ liệu tương tác và ngữ cảnh;
    :Tải mô hình & dữ liệu\n(Encoder từ DB, Config JSON, Weights .h5);
    :Mã hóa đầu vào\n(user→index, item→index, context→vector);
    :Dự đoán song song 4 mô hình\n(ENCM, LNCM, NeuMF, BMF);
    :Lấy Top-K recommendations;
    :Đánh giá online\n(Precision@10, MAP@10);
    
    if (Có lỗi Python?) then (Có)
      :Fallback heuristic\n(Dựa trên độ phổ biến/luật);
    else (Không)
      :Lưu recommendations vào cache;
    endif
    
    :Gắn thông tin sản phẩm;
    :Trả JSON về Frontend;
    stop
  endif
}

@enduml



