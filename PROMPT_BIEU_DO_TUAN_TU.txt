Tạo biểu đồ tuần tự (Sequence Diagram) chi tiết cho hệ thống gợi ý sản phẩm thương mại điện tử theo ngữ cảnh, thể hiện rõ luồng xử lý bên trong hệ thống, các lớp tham gia và kiến trúc phần mềm.

KIẾN TRÚC PHẦN MỀM: MVC (Model-View-Controller) với Service Layer Pattern

CÁC LỚP THAM GIA (theo thứ tự từ trên xuống):

1. **Client (Frontend React)**
   - React Component: Gọi API recommendations
   - Axios Service: Xử lý HTTP requests

2. **Route Layer (Express Router)**
   - web.js: Định tuyến HTTP requests
   - Endpoints: /api/recommendations/list, /api/recommendations/init

3. **Middleware Layer**
   - jwtVerify.js: Xác thực JWT token (verifyTokenUser)
   - Kiểm tra quyền truy cập

4. **Controller Layer**
   - recommendationController.js: Xử lý HTTP request/response
   - Methods: initForCurrentUser(), listForCurrentUser()

5. **Service Layer**
   - recommendationService.js: Business logic
   - Methods: initForUser(), computeRecommendationsForUser(), getCachedForUser()
   - pythonInvoker.js: Bridge để gọi Python ML service

6. **Model Layer (Sequelize ORM)**
   - Recommendation Model: Truy cập bảng recommendations
   - ModelRun Model: Truy cập bảng model_runs
   - Interaction Model: Truy cập bảng interactions
   - Product Model: Truy cập bảng products
   - User Model: Truy cập bảng users

7. **Database (MySQL)**
   - Bảng: recommendations, model_runs, interactions, products, users, rec_user_encoder, rec_item_encoder

8. **Python ML Service**
   - recommend_api.py: Xử lý ML inference
   - model_classes.py: Định nghĩa 4 models (ENCM, LNCM, NeuMF, BMF)

LUỒNG XỬ LÝ CHI TIẾT (Scenario: User request recommendations):

**Activation Box (Lifeline):**
Mỗi lớp có một lifeline (đường thẳng đứng) và activation box khi được gọi.

**Messages (Mũi tên):**
- Synchronous call: → (mũi tên đầy)
- Return: ← (mũi tên đứt nét)
- Asynchronous: →→ (mũi tên đôi)

**Sequence Steps:**

1. **Client → Route Layer**
   - Client: HTTP GET /api/recommendations/list?limit=10
   - Route: Nhận request, định tuyến đến controller

2. **Route → Middleware**
   - Route: Gọi middleware verifyTokenUser
   - Middleware: Kiểm tra JWT token từ header Authorization
   - Middleware: Verify token với secret key
   - Middleware: Lấy user từ database dựa trên token payload
   - Middleware: Kiểm tra roleId (R1, R4 cho admin)
   - Middleware: Attach user vào req.user
   - Middleware → Route: next() (cho phép tiếp tục)

3. **Route → Controller**
   - Route: Gọi recommendationController.listForCurrentUser(req, res)
   - Controller: Extract userId từ req.user.id
   - Controller: Extract limit từ req.query.limit

4. **Controller → Service**
   - Controller: Gọi recommendationService.getCachedForUser(userId, limit)
   - Service: Gọi ensureTables() để đảm bảo tables tồn tại

5. **Service → Model Layer**
   - Service: Gọi db.Recommendation.findAll({ where: { userId }, order: [['score', 'DESC']], limit })
   - Model: Tạo SQL query
   - Model → Database: SELECT * FROM recommendations WHERE userId = ? ORDER BY score DESC LIMIT ?

6. **Database → Model**
   - Database: Trả về kết quả (array of recommendations)
   - Model: Map kết quả thành Sequelize objects

7. **Model → Service**
   - Model: Trả về recommendations array
   - Service: Kiểm tra nếu có cache
   - **Nếu có cache:**
     - Service → Controller: Trả về cached recommendations
     - Controller → Model: Gọi db.Product.findOne() cho mỗi recommendation để hydrate product info
     - Model → Database: SELECT * FROM products WHERE id = ?
     - Database → Model: Trả về product data
     - Model → Controller: Trả về product objects
     - Controller → Client: JSON response { errCode: 0, data: [...] }
   - **Nếu không có cache:**
     - Service: Gọi computeRecommendationsForUser(userId, limit)

8. **Service → Python Invoker (nếu không có cache)**
   - Service: Kiểm tra pythonInvoker có tồn tại không
   - **Nếu có Python:**
     - Service: Gọi pythonInvoker.runPythonInference({ user_id, limit, model, context })
     - PythonInvoker: Tạo child process spawn('python', ['recommend_api.py'])
     - PythonInvoker: Gửi JSON payload qua stdin
     - PythonInvoker → Python Service: JSON request

9. **Python Service xử lý:**
   - recommend_api.py: Đọc JSON từ stdin
   - recommend_api.py: Gọi load_resources() - Load encoders từ database
   - Python Service → Database: SELECT original_id, idx FROM rec_user_encoder
   - Database → Python Service: Trả về user encoder mapping
   - Python Service → Database: SELECT original_id, idx FROM rec_item_encoder WHERE ...
   - Database → Python Service: Trả về item encoder mapping
   - Python Service → Database: SELECT idx, original_id FROM rec_item_encoder JOIN products WHERE statusId='S1'
   - Database → Python Service: Trả về active items
   - recommend_api.py: Encode user_id → user_idx
   - recommend_api.py: _build_model(model_name) - Load model config và weights
   - recommend_api.py: Load model từ .h5 file
   - recommend_api.py: Predict scores cho tất cả items
   - recommend_api.py: Top-K selection
   - Python Service → PythonInvoker: JSON response { ok: true, model: "ENCM", items: [...] }

10. **PythonInvoker → Service**
    - PythonInvoker: Parse JSON response
    - PythonInvoker → Service: Trả về recommendations array

11. **Service xử lý kết quả:**
    - Service: Chạy 4 models song song (ENCM, LNCM, NeuMF, BMF)
    - Service: Tính Precision@10 và MAP@10 cho mỗi model
    - Service: Chọn model tốt nhất
    - Service → Model: db.Recommendation.create() cho mỗi recommendation
    - Model → Database: INSERT INTO recommendations (userId, productId, modelName, score)
    - Database → Model: Confirm insert
    - Model → Service: Trả về created records

12. **Service → Controller**
    - Service: Trả về recommendations array
    - Controller: Hydrate product info cho mỗi recommendation
    - Controller → Model: db.Product.findOne() cho mỗi productId
    - Model → Database: SELECT * FROM products WHERE id = ?
    - Database → Model: Product data
    - Model → Controller: Product objects

13. **Controller → Client**
    - Controller: Tạo JSON response { errCode: 0, data: [{ product, score, modelName }, ...] }
    - Controller: res.status(200).json(response)
    - Client: Nhận và hiển thị recommendations

**Fallback Scenario (nếu Python không khả dụng):**

14. **Service → Model (Heuristic Scoring)**
    - Service: Gọi buildUserProductFeatures(userId)
    - Service → Model: db.Product.findAll() - Lấy tất cả active products
    - Service → Model: db.Interaction.findAll() - Lấy user interactions
    - Service → Model: db.Comment.findAll() - Lấy ratings
    - Service: Tính heuristic score
    - Service → Model: Lưu recommendations
    - Service → Controller: Trả về results

YÊU CẦU VẼ BIỂU ĐỒ:

1. **Format: Mermaid Sequence Diagram**
   - Sử dụng syntax: participant, activate, deactivate, note, alt/opt/loop

2. **Thể hiện rõ:**
   - Tất cả các lớp tham gia (8 lớp chính)
   - Luồng message giữa các lớp
   - Activation boxes cho mỗi lớp khi được gọi
   - Return messages (dotted arrows)
   - Conditional flows (alt/opt cho cache check, Python check)
   - Parallel processing (par block cho 4 models)
   - Loop cho việc hydrate products

3. **Chú thích:**
   - Tên method/function được gọi
   - Parameters quan trọng
   - Return values
   - Database queries (SQL nếu có thể)

4. **Màu sắc/Grouping:**
   - Group các lớp theo layer (Presentation, Business, Data, External)
   - Hoặc sử dụng note để giải thích từng layer

5. **Kiến trúc:**
   - Ghi chú rõ: "MVC Pattern với Service Layer"
   - Thể hiện separation of concerns
   - Thể hiện dependency direction (Controller → Service → Model → Database)

OUTPUT: Code Mermaid Sequence Diagram hoàn chỉnh, có thể render ngay, thể hiện đầy đủ luồng xử lý từ Client đến Database và Python Service.






