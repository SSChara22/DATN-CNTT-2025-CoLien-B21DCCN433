Tạo biểu đồ tuần tự (Mermaid Sequence Diagram) cho hệ thống gợi ý sản phẩm e-commerce, thể hiện luồng xử lý bên trong và các lớp tham gia.

KIẾN TRÚC: MVC (Model-View-Controller) với Service Layer Pattern

CÁC LỚP THAM GIA (từ trên xuống):

1. Client (Frontend React) - Presentation Layer
2. Route Layer (Express Router) - web.js
3. Middleware Layer (jwtVerify.js) - Authentication
4. Controller Layer (recommendationController.js) - Request/Response handling
5. Service Layer (recommendationService.js) - Business logic
6. Python Invoker (pythonInvoker.js) - Bridge to Python
7. Model Layer (Sequelize ORM) - Data access
8. Database (MySQL) - Data persistence
9. Python ML Service (recommend_api.py) - ML inference

LUỒNG XỬ LÝ (Scenario: GET /api/recommendations/list):

1. Client → Route: HTTP GET request
2. Route → Middleware: verifyTokenUser()
3. Middleware → Database: Verify JWT, get user
4. Middleware → Route: next() (attach req.user)
5. Route → Controller: listForCurrentUser(req, res)
6. Controller → Service: getCachedForUser(userId, limit)
7. Service → Model: Recommendation.findAll()
8. Model → Database: SELECT FROM recommendations
9. Database → Model → Service: Return cached data

**Nếu có cache:**
10. Service → Controller: Return recommendations
11. Controller → Model: Product.findOne() (hydrate products)
12. Model → Database: SELECT FROM products
13. Controller → Client: JSON response

**Nếu không có cache:**
10. Service → PythonInvoker: runPythonInference()
11. PythonInvoker → Python Service: spawn('python', ['recommend_api.py'])
12. Python Service → Database: Load encoders (rec_user_encoder, rec_item_encoder)
13. Python Service: Load model weights, predict scores, Top-K
14. Python Service → PythonInvoker: JSON response
15. PythonInvoker → Service: Return recommendations
16. Service → Model: Recommendation.create() (save cache)
17. Model → Database: INSERT INTO recommendations
18. Service → Controller: Return recommendations
19. Controller → Model: Product.findOne() (hydrate)
20. Controller → Client: JSON response

**Fallback (nếu Python lỗi):**
10. Service: buildUserProductFeatures() (heuristic scoring)
11. Service → Model: Product.findAll(), Interaction.findAll()
12. Service: Tính score, lưu cache
13. Service → Controller → Client: Return results

YÊU CẦU:
- Mermaid Sequence Diagram syntax
- Thể hiện: participant, activate, deactivate, alt/opt cho conditional flows
- Parallel processing cho 4 models (par block)
- Loop cho hydrate products
- Chú thích methods và parameters
- Grouping theo layers (Presentation/Business/Data/External)
- Ghi chú: "MVC Pattern với Service Layer"

OUTPUT: Code Mermaid Sequence Diagram hoàn chỉnh, render được ngay.






