Tạo sơ đồ hoạt động (Mermaid flowchart) chi tiết cho hệ thống gợi ý sản phẩm thương mại điện tử theo ngữ cảnh, bao gồm CẢ quá trình TRAINING và INFERENCE với các yêu cầu sau:

KIẾN TRÚC HỆ THỐNG:
- Frontend (React): Giao diện người dùng
- Backend API (Node.js): Xử lý business logic và gọi ML models  
- ML Models (Python/TensorFlow): 4 mô hình deep learning (ENCM, LNCM, NeuMF, BMF)
- Database: MySQL lưu trữ interactions, products, recommendations, model_runs
- Training Pipeline: Python scripts để train và đánh giá models

PHẦN 1: QUÁ TRÌNH TRAINING (OFFLINE - Thực hiện định kỳ)

1. Thu thập dữ liệu từ Database:
   - Lấy interactions: user_id, product_id, action (view/cart/purchase)
   - Lấy thông tin sản phẩm: category, brand, price
   - Lấy context: time_of_day, season, device_type, category
   - Lấy ratings/comments
   - Tạo label: 1 nếu có interaction tích cực, 0 nếu không

2. Tiền xử lý dữ liệu:
   - Làm sạch: loại bỏ duplicates, missing values
   - Encode users và items: LabelEncoder chuyển ID gốc thành index (0,1,2,...)
   - Encode context features: time_of_day, season, device_type, category
   - Tạo mapping: user_encoder, item_encoder, context_encoder
   - Tính n_users, n_items, n_contexts

3. Chia dữ liệu:
   - Train set (80%) và Test set (20%)
   - Đảm bảo test có positive samples
   - Tạo train_user_pos dictionary

4. Tạo DataLoader:
   - RatingDataset class: DataFrame → Tensor
   - DataLoader với batch_size (64-1024), shuffle=True

5. Khởi tạo 4 Models:
   - ENCM: User embedding + Item embedding + Context embeddings → Neural layers
   - LNCM: Linear (MF) + Neural → Combine với alpha
   - NeuMF: GMF + MLP → Combine
   - BMF: Embeddings + Biases

6. Training Loop (mỗi model):
   - Setup: Optimizer (Adam), Loss (BCELoss), Device
   - Epochs loop (10-50):
     * Forward: model(inputs) → predictions
     * Loss: criterion(predictions, labels)
     * Backward: loss.backward()
     * Update: optimizer.step()
     * Tính average loss

7. Đánh giá Models:
   - Leave-one-out evaluation với sampled negatives
   - Metrics: Precision@10, MAP@10, AUC, RMSE
   - So sánh 4 models

8. Lưu Models và Encoders:
   - model.save_weights('models/{name}_model.h5')
   - Lưu config (JSON): n_users, n_items, embedding_dim, hidden_dims
   - Lưu encoders (pickle): user_encoder, item_encoder, context_info

9. Migrate Encoders vào Database:
   - Insert vào rec_user_encoder, rec_item_encoder, rec_context_mapping

PHẦN 2: QUÁ TRÌNH INFERENCE (ONLINE - Khi user request)

1. User Request: User gửi request từ Frontend (userId, limit)

2. Backend nhận request tại endpoint /api/recommendations/list hoặc /api/recommendations/init

3. Kiểm tra Cache: 
   - Nếu có cache hợp lệ → Trả về kết quả từ database
   - Nếu không → Tiến hành tính toán mới

4. Thu thập dữ liệu người dùng:
   - Lịch sử tương tác: view, cart, purchase
   - Thông tin sản phẩm: category, brand từ interactions
   - Context: time_of_day, season, device_type
   - Ground truth: danh sách sản phẩm đã mua

5. Load Models và Encoders:
   - Load encoders từ database
   - Load model configs từ JSON
   - Load model weights từ .h5
   - Build model architecture

6. Encode User và Items:
   - user_idx = user_encoder[user_id]
   - item_indices = [item_encoder[item_id] for item_id in active_items]
   - Tạo context features

7. Gọi Python ML Models (CHẠY SONG SONG):
   - ENCM: [user_indices, item_indices, context_features] → scores → Top-K
   - LNCM: [user_indices, item_indices] → scores → Top-K
   - NeuMF: [user_indices, item_indices] → scores → Top-K
   - BMF: [user_indices, item_indices] → scores → Top-K

8. Đánh giá và chọn mô hình tốt nhất:
   - Tính Precision@10 và MAP@10 cho mỗi mô hình
   - Sắp xếp theo MAP@10 (ưu tiên), sau đó Precision@10
   - Chọn mô hình có điểm cao nhất

9. Fallback (nếu Python không khả dụng):
   - Heuristic scoring từ database
   - Tính điểm: Rating(45%) + Rating_count(15%) + Views(15%) + Discount(15%) + Purchase_intent(10%)
   - Backfill: Thêm sản phẩm cùng category/brand hoặc popular items

10. Lưu Cache: Lưu vào bảng recommendations và model_runs

11. Trả về kết quả: Hydrate thông tin sản phẩm → JSON → Frontend hiển thị

YÊU CẦU:
- Sử dụng Mermaid flowchart syntax
- Phân chia rõ 2 phần: Training (offline) và Inference (online)
- Thể hiện rõ các nhánh điều kiện (if/else)
- Thể hiện luồng song song (parallel processing) cho 4 mô hình
- Thể hiện vòng lặp training (epochs loop)
- Có chú thích cho các bước quan trọng
- Màu sắc phân biệt Training/Inference/Database/Models
- Output: Code Mermaid flowchart hoàn chỉnh, có thể render ngay
