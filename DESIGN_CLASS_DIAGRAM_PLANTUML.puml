@startuml
skinparam classAttributeIconSize 0
skinparam roundcorner 15
skinparam shadowing true
skinparam linetype ortho

' Màu sắc giống Visual Paradigm
skinparam class {
    BackgroundColor #E1F5FF
    BorderColor #0066CC
    ArrowColor #0066CC
    FontColor #000000
    FontStyle bold
}

skinparam classAbstract {
    BackgroundColor #FFF4CC
    BorderColor #FF9900
    FontColor #000000
    FontStyle bold
    FontSize 12
}

skinparam package {
    BackgroundColor #F0F0F0
    BorderColor #666666
    FontColor #000000
    FontStyle bold
}

skinparam note {
    BackgroundColor #FFFFCC
    BorderColor #CCCC00
    FontColor #000000
}

skinparam arrow {
    Color #0066CC
    Thickness 2
}

skinparam database {
    BackgroundColor #E1F5FF
    BorderColor #0066CC
    FontColor #000000
}

title Sơ đồ lớp thiết kế - Hệ thống E-commerce với gợi ý theo ngữ cảnh\n(Design Class Diagram - MVC + Service Layer + ML Service)

' ============================================
' PRESENTATION LAYER
' ============================================
package "Presentation Layer" <<cloud>> {
    class ReactFrontend {
        +components: Component[]
        +services: Service[]
        +getRecommendations(userId, limit)
        +displayProducts(products)
        +trackInteraction(userId, productId, action)
    }
    
    class RecommendationComponent {
        +userId: Integer
        +limit: Integer
        +recommendations: Product[]
        +loadRecommendations()
        +render()
    }
    
    class InteractionService {
        +trackView(userId, productId)
        +trackCart(userId, productId)
        +trackPurchase(userId, productId)
        +detectDevice(): String
    }
}

' ============================================
' ROUTE LAYER
' ============================================
package "Route Layer" {
    class ExpressRouter {
        -routes: Map<String, Handler>
        +registerRoute(method, path, handler)
        +handleRequest(req, res)
        +use(middleware)
    }
    
    class WebRoutes {
        -router: ExpressRouter
        +initRoutes(app)
        +setupUserRoutes()
        +setupProductRoutes()
        +setupRecommendationRoutes()
        +setupOrderRoutes()
    }
}

' ============================================
' MIDDLEWARE LAYER
' ============================================
package "Middleware Layer" {
    class JWTVerifyMiddleware {
        -secretString: String
        +verifyTokenUser(req, res, next)
        +verifyTokenAdmin(req, res, next)
        -extractToken(req): String
        -validateToken(token): Payload
        -getUserFromToken(payload): User
    }
    
    class ValidateInteractionMiddleware {
        +validateInteraction(req, res, next)
        -validateActionCode(code): Boolean
        -validateProductId(id): Boolean
    }
}

' ============================================
' CONTROLLER LAYER
' ============================================
package "Controller Layer" {
    abstract class BaseController {
        <<abstract>>
        +handleRequest(req, res)
        +handleError(error, res)
        +sendResponse(data, res)
    }
    
    class RecommendationController {
        -recommendationService: RecommendationService
        +initForCurrentUser(req, res)
        +listForCurrentUser(req, res)
        +dashboardPage(req, res)
        +clearForCurrentUser(req, res)
        -extractUserId(req): Integer
        -extractLimit(req): Integer
        -hydrateProducts(recommendations): Product[]
    }
    
    class UserController {
        -userService: UserService
        +handleLogin(req, res)
        +handleCreateNewUser(req, res)
        +handleUpdateUser(req, res)
        +handleDeleteUser(req, res)
        +getAllUser(req, res)
        +getDetailUserById(req, res)
    }
    
    class ProductController {
        -productService: ProductService
        +createNewProduct(req, res)
        +updateProduct(req, res)
        +getAllProductAdmin(req, res)
        +getAllProductUser(req, res)
        +getProductRecommend(req, res)
        +getDetailProductById(req, res)
    }
    
    class InteractionController {
        -interactionService: InteractionService
        +logInteractionController(req, res)
        +getUserInteractionsController(req, res)
    }
    
    class OrderController {
        -orderService: OrderService
        +createNewOrder(req, res)
        +getAllOrders(req, res)
        +updateStatusOrder(req, res)
    }
    
    class StatisticController {
        -statisticService: StatisticService
        +getCountCardStatistic(req, res)
        +getStatisticByMonth(req, res)
        +getStatisticByDay(req, res)
    }
}

' ============================================
' SERVICE LAYER
' ============================================
package "Service Layer" {
    abstract class BaseService {
        <<abstract>>
        +validateInput(data): Boolean
        +handleError(error): Error
    }
    
    class RecommendationService {
        -pythonInvoker: PythonInvoker
        -ROOT: String
        -PERF_CSV: String
        +initForUser(userId, limit): Promise<Object>
        +getCachedForUser(userId, limit): Promise<Recommendation[]>
        +clearForUser(userId): Promise<Boolean>
        -computeRecommendationsForUser(userId, limit): Promise<Object>
        -buildUserProductFeatures(userId): Promise<Object[]>
        -ensureTables(): Promise<void>
        -pickBestModel(): String
        -deriveContext(timestamp): Object
        -priceRange(price): String
        -intentFromInteractions(actions): String
        -scoreSample(params): Float
        -rescore(list, weights): Object[]
        -backfillTop(scoredItems): Promise<Object[]>
    }
    
    class PythonInvoker {
        -ROOT: String
        -PYTHON: String
        -SCRIPT: String
        +runPythonInference(payload, options): Promise<Object>
        -spawnPythonProcess(): Process
        -parseResponse(output): Object
        -handleError(error): Object
    }
    
    class UserService {
        +handleLogin(data): Promise<Object>
        +handleCreateNewUser(data): Promise<Object>
        +handleUpdateUser(data): Promise<Object>
        +getAllUser(): Promise<User[]>
        -checkUserEmail(email): Promise<Boolean>
        -hashPassword(password): String
    }
    
    class ProductService {
        +createNewProduct(data): Promise<Object>
        +getAllProductAdmin(): Promise<Product[]>
        +getProductRecommend(data): Promise<Product[]>
        +getDetailProductById(id): Promise<Product>
    }
    
    class InteractionService {
        +logInteraction(userId, productId, actionCode, device): Promise<Interaction>
        +getUserInteractions(userId, filterActionCode): Promise<Interaction[]>
    }
    
    class OrderService {
        +createNewOrder(data): Promise<Order>
        +getAllOrders(): Promise<Order[]>
        +updateStatusOrder(id, status): Promise<Order>
    }
    
    class StatisticService {
        +getCountCardStatistic(query): Promise<Object>
        +getStatisticByMonth(query): Promise<Object>
        +getStatisticByDay(query): Promise<Object>
    }
}

' ============================================
' MODEL LAYER (Sequelize ORM)
' ============================================
package "Model Layer (Sequelize ORM)" {
    abstract class SequelizeModel {
        <<abstract>>
        +id: Integer {primaryKey, autoIncrement}
        +createdAt: Date
        +updatedAt: Date
        +findAll(options): Promise<Model[]>
        +findOne(options): Promise<Model>
        +create(data): Promise<Model>
        +update(data, options): Promise<Model>
        +destroy(options): Promise<Integer>
        +belongsTo(target, options)
        +hasMany(target, options)
    }
    
    class Recommendation {
        +userId: Integer {FK}
        +productId: Integer {FK}
        +modelName: String
        +score: Float
        +details: Text
        +belongsTo(User)
        +belongsTo(Product)
    }
    
    class ModelRun {
        +userId: Integer {FK}
        +modelName: String
        +metricsJson: Text
        +recommendationsJson: Text
        +belongsTo(User)
    }
    
    class User {
        +email: String {unique}
        +password: String
        +firstName: String
        +lastName: String
        +roleId: String {FK}
        +statusId: String {FK}
        +hasMany(Recommendation)
        +hasMany(ModelRun)
        +hasMany(Interaction)
        +hasMany(Order)
    }
    
    class Product {
        +name: String
        +categoryId: String {FK}
        +brandId: String {FK}
        +statusId: String {FK}
        +view: Integer
        +hasMany(Recommendation)
        +hasMany(Interaction)
        +hasMany(Comment)
        +hasMany(ProductDetail)
    }
    
    class Interaction {
        +userId: Integer {FK}
        +productId: Integer {FK}
        +actionCode: String {FK}
        +device_type: String
        +timestamp: Date
        +belongsTo(User)
        +belongsTo(Product)
    }
    
    class Comment {
        +userId: Integer {FK}
        +productId: Integer {FK}
        +star: Integer
        +content: Text
        +belongsTo(User)
        +belongsTo(Product)
    }
    
    class Order {
        +userId: Integer {FK}
        +statusId: String {FK}
        +totalPrice: Float
        +belongsTo(User)
        +hasMany(OrderDetail)
    }
    
    class ProductDetail {
        +productId: Integer {FK}
        +originalPrice: Float
        +discountPrice: Float
        +belongsTo(Product)
    }
}

' ============================================
' DATABASE CONNECTION
' ============================================
package "Database Layer" {
    class SequelizeConnection {
        -sequelize: Sequelize
        -db: Object
        +authenticate(): Promise<void>
        +sync(options): Promise<void>
        +loadModels(): void
        +associateModels(): void
    }
    
    database MySQL {
        table recommendations
        table model_runs
        table users
        table products
        table interactions
        table comments
        table orders
        table product_details
        table rec_user_encoder
        table rec_item_encoder
        table rec_context_mapping
    }
}

' ============================================
' PYTHON ML SERVICE
' ============================================
package "Python ML Service" {
    abstract class TensorFlowModel {
        <<abstract>>
        +n_users: Integer
        +n_items: Integer
        +embedding_dim: Integer
        +call(inputs, training): Tensor
        +load_weights(path): void
        +predict(inputs): Tensor
    }
    
    class ENCM {
        +n_contexts: List<Integer>
        +context_dim: Integer
        +hidden_dims: List<Integer>
        +user_embedding: Embedding
        +item_embedding: Embedding
        +context_embeddings: List<Embedding>
        +hidden_layers: List<Dense>
        +output_layer: Dense
        +call(user_ids, item_ids, context_features): Tensor
    }
    
    class LNCM {
        +hidden_dims: List<Integer>
        +user_embedding: Embedding
        +item_embedding: Embedding
        +linear_layer: Dense
        +hidden_layers: List<Dense>
        +neural_layer: Dense
        +alpha: Weight
        +call(user_ids, item_ids): Tensor
    }
    
    class NeuMF {
        +hidden_dims: List<Integer>
        +user_embedding_gmf: Embedding
        +item_embedding_gmf: Embedding
        +user_embedding_mlp: Embedding
        +item_embedding_mlp: Embedding
        +mlp_layers: List<Dense>
        +final_layer: Dense
        +call(user_ids, item_ids): Tensor
    }
    
    class BMF {
        +user_embedding: Embedding
        +item_embedding: Embedding
        +user_bias: Embedding
        +item_bias: Embedding
        +global_bias: Weight
        +call(user_ids, item_ids): Tensor
    }
    
    class RecommendAPI {
        -DB_HOST: String
        -DB_PORT: Integer
        -DB_USER: String
        -DB_PASS: String
        -DB_NAME: String
        -_cached: Dict {Singleton}
        +handle_request(req): Dict
        -load_resources(): void
        -db_connect(): Connection
        -_build_model(model_name, configs): TensorFlowModel {Factory}
        -_encode_user(user_id, user_map): Integer
        -_decode_item_index(idx): Integer
        -_candidate_indices_from_db(): Array
        -_context_to_features(context, context_info): Array
    }
    
    class ModelFactory {
        <<Factory>>
        +createModel(model_name, config): TensorFlowModel
        +loadConfig(model_name): Dict
        +loadWeights(model, model_name): void
    }
}

' ============================================
' RELATIONSHIPS
' ============================================

' Presentation Layer
ReactFrontend --> RecommendationComponent : contains
ReactFrontend --> InteractionService : uses

' Route Layer
ExpressRouter --> WebRoutes : uses
WebRoutes --> RecommendationController : routes to
WebRoutes --> UserController : routes to
WebRoutes --> ProductController : routes to
WebRoutes --> InteractionController : routes to
WebRoutes --> OrderController : routes to
WebRoutes --> StatisticController : routes to

' Middleware
ExpressRouter --> JWTVerifyMiddleware : uses
ExpressRouter --> ValidateInteractionMiddleware : uses
JWTVerifyMiddleware --> User : queries

' Controller Layer
BaseController <|-- RecommendationController
BaseController <|-- UserController
BaseController <|-- ProductController
BaseController <|-- InteractionController
BaseController <|-- OrderController
BaseController <|-- StatisticController

RecommendationController --> RecommendationService : uses
UserController --> UserService : uses
ProductController --> ProductService : uses
InteractionController --> InteractionService : uses
OrderController --> OrderService : uses
StatisticController --> StatisticService : uses

' Service Layer
BaseService <|-- RecommendationService
BaseService <|-- UserService
BaseService <|-- ProductService
BaseService <|-- InteractionService
BaseService <|-- OrderService
BaseService <|-- StatisticService

RecommendationService --> PythonInvoker : uses
RecommendationService --> Recommendation : creates/queries
RecommendationService --> ModelRun : creates/queries
RecommendationService --> Product : queries
RecommendationService --> User : queries
RecommendationService --> Interaction : queries
RecommendationService --> Comment : queries

PythonInvoker --> RecommendAPI : spawns process

UserService --> User : queries/creates
ProductService --> Product : queries/creates
InteractionService --> Interaction : creates/queries
OrderService --> Order : creates/queries
StatisticService --> Order : queries
StatisticService --> Product : queries

' Model Layer
SequelizeModel <|-- Recommendation
SequelizeModel <|-- ModelRun
SequelizeModel <|-- User
SequelizeModel <|-- Product
SequelizeModel <|-- Interaction
SequelizeModel <|-- Comment
SequelizeModel <|-- Order
SequelizeModel <|-- ProductDetail

Recommendation "0..*" --> "1" User : belongsTo
Recommendation "0..*" --> "1" Product : belongsTo
ModelRun "0..*" --> "1" User : belongsTo
Interaction "0..*" --> "1" User : belongsTo
Interaction "0..*" --> "1" Product : belongsTo
Comment "0..*" --> "1" User : belongsTo
Comment "0..*" --> "1" Product : belongsTo
Order "0..*" --> "1" User : belongsTo
ProductDetail "0..*" --> "1" Product : belongsTo

User "1" --> "0..*" Recommendation : hasMany
User "1" --> "0..*" ModelRun : hasMany
User "1" --> "0..*" Interaction : hasMany
User "1" --> "0..*" Order : hasMany
Product "1" --> "0..*" Recommendation : hasMany
Product "1" --> "0..*" Interaction : hasMany
Product "1" --> "0..*" Comment : hasMany
Product "1" --> "0..*" ProductDetail : hasMany

' Database
SequelizeConnection --> MySQL : connects to
SequelizeModel --> SequelizeConnection : uses

' Python ML Service
TensorFlowModel <|-- ENCM
TensorFlowModel <|-- LNCM
TensorFlowModel <|-- NeuMF
TensorFlowModel <|-- BMF

RecommendAPI --> ModelFactory : uses {Factory Pattern}
ModelFactory --> ENCM : creates
ModelFactory --> LNCM : creates
ModelFactory --> NeuMF : creates
ModelFactory --> BMF : creates

RecommendAPI --> MySQL : queries encoders
RecommendAPI --> ENCM : uses
RecommendAPI --> LNCM : uses
RecommendAPI --> NeuMF : uses
RecommendAPI --> BMF : uses

' Design Patterns Notes
note right of RecommendAPI
  **Singleton Pattern**
  _cached dictionary stores
  loaded models and encoders
  to avoid reloading
end note

note right of ModelFactory
  **Factory Pattern**
  Creates appropriate model
  instance based on model_name
end note

note right of RecommendationService
  **Strategy Pattern**
  Selects best model based on
  performance metrics (MAP@10)
end note

note right of BaseController
  **Template Method Pattern**
  Common request handling
  structure with error handling
end note

@enduml

