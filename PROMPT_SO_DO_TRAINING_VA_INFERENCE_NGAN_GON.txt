Tạo sơ đồ hoạt động (Mermaid flowchart) cho hệ thống gợi ý sản phẩm e-commerce, bao gồm CẢ TRAINING và INFERENCE:

KIẾN TRÚC:
- Frontend (React) → Backend (Node.js) → ML Models (Python/TensorFlow) → Database (MySQL)
- Training Pipeline: Python scripts train models offline

PHẦN 1: TRAINING (OFFLINE - Định kỳ)

1. Thu thập dữ liệu từ DB: interactions, products, context, ratings
2. Tiền xử lý: Clean data → Encode users/items/contexts (LabelEncoder) → Tính n_users, n_items, n_contexts
3. Chia dữ liệu: Train (80%) / Test (20%) với positive samples
4. Tạo DataLoader: RatingDataset → DataLoader (batch_size, shuffle)
5. Khởi tạo 4 Models: ENCM, LNCM, NeuMF, BMF (mỗi model có architecture riêng)
6. Training Loop (mỗi model):
   - Setup: Optimizer (Adam), Loss (BCELoss), Device
   - Epochs loop (10-50):
     * Forward: model(inputs) → predictions
     * Loss: criterion(predictions, labels)
     * Backward: loss.backward()
     * Update: optimizer.step()
   - Tính average loss mỗi epoch
7. Evaluation:
   - Leave-one-out với sampled negatives
   - Metrics: Precision@10, MAP@10, AUC, RMSE
   - So sánh 4 models
8. Lưu Models:
   - model.save_weights('models/{name}_model.h5')
   - Lưu config (JSON): n_users, n_items, embedding_dim, hidden_dims
   - Lưu encoders (pickle): user_encoder, item_encoder, context_info
9. Migrate vào DB: Insert encoders vào rec_user_encoder, rec_item_encoder, rec_context_mapping

PHẦN 2: INFERENCE (ONLINE - Khi user request)

1. User Request: Frontend gửi (userId, limit)
2. Backend: /api/recommendations/list hoặc /init
3. Check Cache: Có cache? → Return / Không → Tính toán
4. Thu thập data: Interactions, context hiện tại, ground truth
5. Load Models: Encoders từ DB → Config từ JSON → Weights từ .h5 → Build model
6. Encode: user_id → user_idx, items → item_indices, context → context_features
7. Chạy 4 Models SONG SONG:
   - ENCM: [user_idx, item_idx, context] → scores → Top-K
   - LNCM: [user_idx, item_idx] → scores → Top-K
   - NeuMF: [user_idx, item_idx] → scores → Top-K
   - BMF: [user_idx, item_idx] → scores → Top-K
8. Đánh giá: Tính Precision@10, MAP@10 → Chọn model tốt nhất
9. Fallback (nếu Python lỗi): Heuristic scoring từ DB
10. Lưu Cache: recommendations, model_runs tables
11. Return: Hydrate product info → JSON → Frontend hiển thị

YÊU CẦU:
- Mermaid flowchart syntax
- Phân chia rõ: Training (offline) vs Inference (online)
- Thể hiện: Training loop, parallel models, cache check, fallback
- Màu sắc phân biệt phases
- Chú thích rõ ràng
- Output: Code Mermaid hoàn chỉnh, render được ngay






