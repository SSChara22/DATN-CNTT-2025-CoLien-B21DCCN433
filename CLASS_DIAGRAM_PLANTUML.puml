@startuml
skinparam classAttributeIconSize 0
skinparam roundcorner 15
skinparam shadowing true

' Màu sắc giống Visual Paradigm
skinparam class {
    BackgroundColor #E1F5FF
    BorderColor #0066CC
    ArrowColor #0066CC
    FontColor #000000
    FontStyle bold
}

skinparam classAbstract {
    BackgroundColor #FFF4CC
    BorderColor #FF9900
    FontColor #000000
    FontStyle bold
    FontSize 12
}

skinparam package {
    BackgroundColor #F0F0F0
    BorderColor #666666
    FontColor #000000
    FontStyle bold
}

skinparam note {
    BackgroundColor #FFFFCC
    BorderColor #CCCC00
    FontColor #000000
}

skinparam arrow {
    Color #0066CC
    Thickness 2
}

skinparam database {
    BackgroundColor #E1F5FF
    BorderColor #0066CC
    FontColor #000000
}

title Biểu đồ lớp - Hệ thống gợi ý sản phẩm E-commerce\n(Class Diagram - MVC Architecture)

package "Presentation Layer" {
    class FrontendComponent {
        +userId: Integer
        +limit: Integer
        +getRecommendations()
        +displayRecommendations()
        +trackInteraction()
    }
}

package "Route Layer" {
    class ExpressRouter {
        +routes: Map
        +registerRoute(path, handler)
        +handleRequest(req, res)
    }
}

package "Middleware Layer" {
    class JWTVerifyMiddleware {
        +secretString: String
        +verifyTokenUser(req, res, next)
        +verifyTokenAdmin(req, res, next)
        +extractToken(req)
        +validateUser(user)
    }
}

package "Controller Layer" {
    class RecommendationController {
        +initForCurrentUser(req, res)
        +listForCurrentUser(req, res)
        +dashboardPage(req, res)
        +clearForCurrentUser(req, res)
    }
}

package "Service Layer" {
    class RecommendationService {
        -pythonInvoker: PythonInvoker
        -ROOT: String
        -PERF_CSV: String
        +initForUser(userId, limit)
        +getCachedForUser(userId, limit)
        +clearForUser(userId)
        -computeRecommendationsForUser(userId, limit)
        -buildUserProductFeatures(userId)
        -ensureTables()
        -pickBestModel()
        -deriveContext(timestamp)
        -priceRange(price)
        -intentFromInteractions(actions)
        -scoreSample(params)
    }
    
    class PythonInvoker {
        -ROOT: String
        -PYTHON: String
        -SCRIPT: String
        +runPythonInference(payload, options)
        -spawnPythonProcess()
        -parseResponse(output)
    }
}

package "Model Layer (Sequelize ORM)" {
    abstract class SequelizeModel {
        +id: Integer
        +createdAt: Date
        +updatedAt: Date
        +findAll(options)
        +findOne(options)
        +create(data)
        +update(data)
        +destroy(options)
    }
    
    class Recommendation <<SequelizeModel>> {
        +userId: Integer
        +productId: Integer
        +modelName: String
        +score: Float
        +details: Text
        +belongsTo(User)
        +belongsTo(Product)
    }
    
    class ModelRun <<SequelizeModel>> {
        +userId: Integer
        +modelName: String
        +metricsJson: Text
        +recommendationsJson: Text
        +belongsTo(User)
    }
    
    class Product <<SequelizeModel>> {
        +name: String
        +categoryId: String
        +brandId: String
        +statusId: String
        +view: Integer
        +hasMany(Recommendation)
        +hasMany(Interaction)
        +hasMany(Comment)
    }
    
    class User <<SequelizeModel>> {
        +email: String
        +password: String
        +roleId: String
        +firstName: String
        +lastName: String
        +hasMany(Recommendation)
        +hasMany(ModelRun)
        +hasMany(Interaction)
    }
    
    class Interaction <<SequelizeModel>> {
        +userId: Integer
        +productId: Integer
        +actionCode: String
        +device_type: String
        +timestamp: Date
        +belongsTo(User)
        +belongsTo(Product)
    }
    
    class Comment <<SequelizeModel>> {
        +userId: Integer
        +productId: Integer
        +star: Integer
        +content: Text
        +belongsTo(User)
        +belongsTo(Product)
    }
}

package "Database Layer" {
    database MySQL {
        table recommendations
        table model_runs
        table products
        table users
        table interactions
        table comments
        table rec_user_encoder
        table rec_item_encoder
        table rec_context_mapping
    }
}

package "Python ML Service" {
    abstract class TensorFlowModel {
        +n_users: Integer
        +n_items: Integer
        +embedding_dim: Integer
        +call(inputs, training)
        +load_weights(path)
        +predict(inputs)
    }
    
    class ENCM <<TensorFlowModel>> {
        +n_contexts: List<Integer>
        +context_dim: Integer
        +hidden_dims: List<Integer>
        +user_embedding: Embedding
        +item_embedding: Embedding
        +context_embeddings: List<Embedding>
        +hidden_layers: List<Dense>
        +output_layer: Dense
        +call(user_ids, item_ids, context_features)
    }
    
    class LNCM <<TensorFlowModel>> {
        +hidden_dims: List<Integer>
        +user_embedding: Embedding
        +item_embedding: Embedding
        +linear_layer: Dense
        +hidden_layers: List<Dense>
        +neural_layer: Dense
        +alpha: Weight
        +call(user_ids, item_ids)
    }
    
    class NeuMF <<TensorFlowModel>> {
        +hidden_dims: List<Integer>
        +user_embedding_gmf: Embedding
        +item_embedding_gmf: Embedding
        +user_embedding_mlp: Embedding
        +item_embedding_mlp: Embedding
        +mlp_layers: List<Dense>
        +final_layer: Dense
        +call(user_ids, item_ids)
    }
    
    class BMF <<TensorFlowModel>> {
        +user_embedding: Embedding
        +item_embedding: Embedding
        +user_bias: Embedding
        +item_bias: Embedding
        +global_bias: Weight
        +call(user_ids, item_ids)
    }
    
    class RecommendAPI {
        -DB_HOST: String
        -DB_PORT: Integer
        -DB_USER: String
        -DB_PASS: String
        -DB_NAME: String
        -_cached: Dict
        +handle_request(req)
        -load_resources()
        -db_connect()
        -_build_model(model_name, configs)
        -_encode_user(user_id, user_map)
        -_decode_item_index(idx)
        -_candidate_indices_from_db()
        -_context_to_features(context, context_info)
    }
}

' Relationships
FrontendComponent --> ExpressRouter : HTTP Request
ExpressRouter --> JWTVerifyMiddleware : uses
JWTVerifyMiddleware --> User : queries
JWTVerifyMiddleware --> ExpressRouter : next()
ExpressRouter --> RecommendationController : routes to

RecommendationController --> RecommendationService : uses
RecommendationController --> Product : queries
RecommendationController --> Recommendation : queries

RecommendationService --> PythonInvoker : uses
RecommendationService --> Recommendation : creates/queries
RecommendationService --> ModelRun : creates/queries
RecommendationService --> Product : queries
RecommendationService --> User : queries
RecommendationService --> Interaction : queries
RecommendationService --> Comment : queries
RecommendationService --> MySQL : queries

PythonInvoker --> RecommendAPI : spawns process

RecommendAPI --> MySQL : queries encoders
RecommendAPI --> ENCM : uses
RecommendAPI --> LNCM : uses
RecommendAPI --> NeuMF : uses
RecommendAPI --> BMF : uses

Recommendation --> User : belongsTo
Recommendation --> Product : belongsTo
ModelRun --> User : belongsTo
Interaction --> User : belongsTo
Interaction --> Product : belongsTo
Comment --> User : belongsTo
Comment --> Product : belongsTo

User --> Recommendation : hasMany
User --> ModelRun : hasMany
User --> Interaction : hasMany
Product --> Recommendation : hasMany
Product --> Interaction : hasMany
Product --> Comment : hasMany

SequelizeModel <|-- Recommendation
SequelizeModel <|-- ModelRun
SequelizeModel <|-- Product
SequelizeModel <|-- User
SequelizeModel <|-- Interaction
SequelizeModel <|-- Comment

TensorFlowModel <|-- ENCM
TensorFlowModel <|-- LNCM
TensorFlowModel <|-- NeuMF
TensorFlowModel <|-- BMF

note right of RecommendationService
  Business Logic Layer
  - Handles recommendation computation
  - Manages cache
  - Evaluates models
  - Fallback to heuristic scoring
end note

note right of PythonInvoker
  Bridge Pattern
  - Spawns Python process
  - Communicates via stdin/stdout
  - JSON serialization
end note

note right of ENCM
  Context-aware Model
  - Uses time, season, device, category
  - Embedding-based neural network
end note

note right of LNCM
  Linear + Neural Combination
  - Matrix Factorization + MLP
  - Learnable alpha weight
end note

note right of NeuMF
  Neural Matrix Factorization
  - GMF (Generalized MF) + MLP
  - Two-tower architecture
end note

note right of BMF
  Bias Matrix Factorization
  - User/Item embeddings
  - User/Item/Global biases
end note

@enduml

