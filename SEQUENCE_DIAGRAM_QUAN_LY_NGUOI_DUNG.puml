@startuml
!theme plain
skinparam sequenceMessageAlign center
skinparam roundcorner 5
skinparam shadowing false

' Điều chỉnh để hiển thị gọn trong 1 trang
skinparam ParticipantPadding 5
skinparam BoxPadding 3
skinparam LifeLineBorderThickness 1
skinparam ArrowThickness 1
skinparam ArrowFontSize 8
skinparam ParticipantFontSize 9
skinparam ActorFontSize 9

title Sơ đồ tuần tự - Quản lý người dùng\n(Sequence Diagram - User Management)

' ============================================
' 1. ĐĂNG KÝ NGƯỜI DÙNG MỚI
' ============================================

== Đăng ký ==

actor "User" as User
participant "Frontend" as Frontend
participant "Controller" as Controller
participant "Service" as Service
participant "Model" as Model
database "DB" as DB

User -> Frontend: Đăng ký
Frontend -> Controller: POST /api/create-new-user
Controller -> Service: handleCreateNewUser()
Service -> Model: checkUserEmail()
Model -> DB: SELECT email
DB -> Model: Result
Model -> Service: Email exists?

alt Email đã tồn tại
    Service -> Controller: {errCode: 1}
    Controller -> Frontend: Error
    Frontend -> User: Lỗi
else Email OK
    Service -> Service: hashPassword()
    Service -> Model: User.create()
    Model -> DB: INSERT
    Service -> Controller: {errCode: 0}
    Controller -> Frontend: Success
    Frontend -> User: Thành công
end

' ============================================
' 2. ĐĂNG NHẬP
' ============================================

== Đăng nhập ==

User -> Frontend: Login
Frontend -> Controller: POST /api/login
Controller -> Service: handleLogin()
Service -> Model: User.findOne()
Model -> DB: SELECT * WHERE email
DB -> Model: User data
Service -> Service: bcrypt.compare()

alt Mật khẩu sai
    Service -> Controller: {errCode: 3}
    Controller -> Frontend: Error
    Frontend -> User: Lỗi
else Mật khẩu đúng
    Service -> Service: encodeToken()
    Service -> Service: initRecommendations()
    Service -> Controller: {errCode: 0, token}
    Controller -> Frontend: Success + Token
    Frontend -> User: Chuyển trang
end

' ============================================
' 3. CẬP NHẬT THÔNG TIN
' ============================================

== Cập nhật ==

participant "JWT" as JWT

User -> Frontend: Update
Frontend -> Controller: PUT /api/update-user
Controller -> JWT: verifyToken()
JWT -> Controller: OK
Controller -> Service: updateUserData()
Service -> Model: User.findOne()
Model -> DB: SELECT WHERE id
Service -> Model: user.save()
Model -> DB: UPDATE
Service -> Controller: {errCode: 0}
Controller -> Frontend: Success
Frontend -> User: Thành công

' ============================================
' 4. XÓA NGƯỜI DÙNG
' ============================================

== Xóa (Admin) ==

actor "Admin" as Admin

Admin -> Frontend: Delete
Frontend -> Controller: DELETE /api/delete-user
Controller -> JWT: verifyTokenAdmin()
JWT -> Controller: OK
Controller -> Service: deleteUser()
Service -> Model: User.findOne()
Model -> DB: SELECT
Service -> Model: User.destroy()
Model -> DB: DELETE
Service -> Controller: {errCode: 0}
Controller -> Frontend: Success
Frontend -> Admin: Thành công

' ============================================
' 5. XEM DANH SÁCH
' ============================================

== Danh sách (Admin) ==

Admin -> Frontend: List
Frontend -> Controller: GET /api/get-all-user
Controller -> JWT: verifyTokenAdmin()
JWT -> Controller: OK
Controller -> Service: getAllUser()
Service -> Model: findAndCountAll()
Model -> DB: SELECT + JOIN
DB -> Model: {rows, count}
Service -> Controller: {errCode: 0, data, count}
Controller -> Frontend: JSON
Frontend -> Admin: Hiển thị

' ============================================
' 6. XEM CHI TIẾT
' ============================================

== Chi tiết ==

User -> Frontend: View
Frontend -> Controller: GET /api/get-detail-user-by-id
Controller -> Service: getDetailUserById()
Service -> Model: User.findOne() + include
Model -> DB: SELECT + JOIN
DB -> Model: User data
Service -> Controller: {errCode: 0, data}
Controller -> Frontend: JSON
Frontend -> User: Hiển thị

' ============================================
' 7. ĐỔI MẬT KHẨU
' ============================================

== Đổi mật khẩu ==

User -> Frontend: Change password
Frontend -> Controller: POST /api/changepassword
Controller -> JWT: verifyToken()
JWT -> Controller: OK
Controller -> Service: handleChangePassword()
Service -> Model: User.findOne()
Model -> DB: SELECT
Service -> Service: bcrypt.compare(old)

alt Mật khẩu cũ sai
    Service -> Controller: {errCode: 2}
    Controller -> Frontend: Error
    Frontend -> User: Lỗi
else Mật khẩu cũ đúng
    Service -> Service: hashPassword(new)
    Service -> Model: user.save()
    Model -> DB: UPDATE password
    Service -> Controller: {errCode: 0}
    Controller -> Frontend: Success
    Frontend -> User: Thành công
end

@enduml
