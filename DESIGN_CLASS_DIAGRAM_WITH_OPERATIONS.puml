@startuml
skinparam classAttributeIconSize 0
skinparam roundcorner 8
skinparam shadowing false
skinparam linetype ortho

skinparam padding 1
skinparam nodesep 1
skinparam ranksep 2

skinparam class {
    BackgroundColor #E1F5FF
    BorderColor #0066CC
    ArrowColor #0066CC
    FontColor #000000
    FontStyle bold
    FontSize 6
}

skinparam package {
    BackgroundColor #F0F0F0
    BorderColor #666666
    FontColor #000000
    FontStyle bold
    FontSize 7
}

title Sơ đồ lớp thiết kế - Hệ thống E-commerce\n(Design Class Diagram)

' ============================================
' CORE ENTITIES
' ============================================
package "Core" #DDDDDD {
    class User {
        -id: Integer {PK}
        -email: String
        -password: String
        --
        +login(email: String, password: String): Object
        +createUser(data: Object): Object
        +updateUserData(data: Object): Object
        +deleteUser(userId: Integer): Object
        +getAllUser(query: Object): Object
    }

    class Product {
        -id: Integer {PK}
        -name: String
        -categoryId: String {FK}
        --
        +createProduct(data: Object): Object
        +updateProduct(data: Object): Object
        +getAllProductUser(query: Object): Object
        +getDetailProductById(id: Integer): Object
        +getProductRecommend(data: Object): Object
    }

    class ProductDetail {
        -id: Integer {PK}
        -productId: Integer {FK}
        -discountPrice: BigInteger
        --
        +createProductDetail(data: Object): Object
        +updateProductDetail(data: Object): Object
        +deleteProductDetail(id: Integer): Object
    }

    class ProductDetailSize {
        -id: Integer {PK}
        -productdetailId: Integer {FK}
        --
        +createProductDetailSize(data: Object): Object
        +checkStock(): Integer
    }
}

' ============================================
' CART & ORDER
' ============================================
package "Order" #DDDDDD {
    class ShopCart {
        -id: Integer {PK}
        -userId: Integer {FK}
        -quantity: Integer
        --
        +addShopCart(data: Object): Object
        +getAllShopCartByUserId(userId: Integer): Object
        +deleteItemShopCart(id: Integer): Object
    }

    class OrderProduct {
        -id: Integer {PK}
        -statusId: String {FK}
        --
        +createNewOrder(data: Object): Object
        +getAllOrders(query: Object): Object
        +updateStatusOrder(data: Object): Object
        +paymentOrder(data: Object): Object
        +calculateTotal(): BigInteger
    }

    class OrderDetail {
        -id: Integer {PK}
        -orderId: Integer {FK}
        -quantity: Integer
    }
}

' ============================================
' VOUCHER
' ============================================
package "Voucher" #DDDDDD {
    class Voucher {
        -id: Integer {PK}
        -codeVoucher: String
        --
        +createNewVoucher(data: Object): Object
        +isValid(): Boolean
        +calculateDiscount(totalPrice: BigInteger): BigInteger
    }
}

' ============================================
' ADDRESS
' ============================================
package "Address" #DDDDDD {
    class AddressUser {
        -id: Integer {PK}
        -userId: Integer {FK}
        -shipAdress: String
    }
}

' ============================================
' ML RECOMMENDATION SERVICE
' ============================================
package "ML Recommendation Service" #DDDDDD {
    class RecommendationService {
        --
        +initForUser(userId: Integer, limit: Integer): Object
        +getCachedForUser(userId: Integer, limit: Integer): Object
        +clearForUser(userId: Integer): Boolean
        +computeRecommendationsForUser(userId: Integer, limit: Integer): Object
        +buildUserProductFeatures(userId: Integer): Object[]
        +deriveContext(timestamp: Date): Object
        +pickBestModel(): String
    }

    class RecommendationEngine {
        --
        +generateRecommendations(userId: Integer, limit: Integer): Recommendation[]
        +evaluateModels(modelRuns: Object[]): Object
        +selectBestModel(modelRuns: Object[]): String
    }

    abstract class RecommendationModel {
        <<abstract>>
        +predict(userId: Integer, context: Object): Float[]
    }

    class ENCM {
        +predict(userId: Integer, context: Object): Float[]
    }

    class LNCM {
        +predict(userId: Integer, context: Object): Float[]
    }

    class NeuMF {
        +predict(userId: Integer, context: Object): Float[]
    }

    class BMF {
        +predict(userId: Integer, context: Object): Float[]
    }
}

' ============================================
' STATISTICS SERVICE
' ============================================
package "Statistics Service" #DDDDDD {
    class StatisticService {
        --
        +getCountCardStatistic(): Object
        +getCountStatusOrder(data: Object): Object
        +getStatisticByMonth(data: Object): Object
        +getStatisticByDay(data: Object): Object
        +getStatisticProfit(data: Object): Object
        +getStatisticOverturn(data: Object): Object
        +getStatisticStockProduct(data: Object): Object
    }
}

' ============================================
' ALLCODE - Lookup Table
' ============================================
package "Lookup" #DDDDDD {
    class Allcode {
        -id: Integer {PK}
        -type: String
        -value: String
        -code: String {unique}
    }
}

' ============================================
' RELATIONSHIPS
' ============================================

' User relationships
User "1" --> "0..1" Allcode : role >
User "1" --> "0..*" AddressUser : addresses >
User "1" --> "0..*" ShopCart : cart >
User "1" --> "0..*" OrderProduct : orders >
User "1" --> "0..*" Receipt : receipts >
User "1" --> "0..*" VoucherUsed : vouchers >
User "1" --> "0..*" Interaction : interactions >
User "1" --> "0..*" Recommendation : recommendations >
User "1" --> "0..*" Comment : comments >
User ..> RecommendationService : uses >

' Product relationships
Product "1" --> "0..1" Allcode : category >
Product "1" --> "0..1" Allcode : brand >
Product "1" --> "0..*" ProductDetail : details >
Product "1" --> "0..*" Interaction : interactions >
Product "1" --> "0..*" Recommendation : recommended >
Product "1" --> "0..*" Comment : comments >

' ProductDetail relationships
ProductDetail "1" --> "1" Product : belongs >
ProductDetail "1" --> "0..*" ProductImage : images >
ProductDetail "1" --> "0..*" ProductDetailSize : sizes >

' ProductDetailSize relationships
ProductDetailSize "1" --> "1" ProductDetail : belongs >
ProductDetailSize "1" --> "0..1" Allcode : size >
ProductDetailSize "1" --> "0..*" ShopCart : in cart >
ProductDetailSize "1" --> "0..*" OrderDetail : in orders >
ProductDetailSize "1" --> "0..*" ReceiptDetail : in receipts >

' ShopCart relationships
ShopCart "1" --> "1" User : belongs >
ShopCart "1" --> "1" ProductDetailSize : references >

' OrderProduct relationships
OrderProduct "1" --> "1" AddressUser : ships to >
OrderProduct "1" --> "0..1" TypeShip : shipping >
OrderProduct "1" --> "0..1" Voucher : voucher >
OrderProduct "1" --> "0..1" Allcode : status >
OrderProduct "1" --> "0..1" User : shipper >
OrderProduct "1" --> "1..*" OrderDetail : contains >

' OrderDetail relationships
OrderDetail "1" --> "1" OrderProduct : belongs >
OrderDetail "1" --> "1" ProductDetailSize : references >

' Voucher relationships
Voucher "1" --> "1" TypeVoucher : has type >
Voucher "1" --> "0..*" OrderProduct : used in >
Voucher "1" --> "0..*" VoucherUsed : usage >

' TypeVoucher relationships
TypeVoucher "1" --> "0..1" Allcode : type code >
TypeVoucher "1" --> "0..*" Voucher : vouchers >

' VoucherUsed relationships
VoucherUsed "1" --> "1" Voucher : references >
VoucherUsed "1" --> "1" User : used by >

' Receipt relationships
Receipt "1" --> "1" User : created by >
Receipt "1" --> "1" Supplier : from >
Receipt "1" --> "1..*" ReceiptDetail : contains >

' ReceiptDetail relationships
ReceiptDetail "1" --> "1" Receipt : belongs >
ReceiptDetail "1" --> "1" ProductDetailSize : references >

' Supplier relationships
Supplier "1" --> "0..*" Receipt : supplies >

' Interaction relationships
Interaction "1" --> "1" User : performed by >
Interaction "1" --> "1" Product : on product >
Interaction "1" --> "0..1" Allcode : action type >

' Recommendation relationships
Recommendation "1" --> "1" User : for user >
Recommendation "1" --> "1" Product : recommends >

' Comment relationships
Comment "1" --> "1" User : written by >
Comment "1" --> "0..1" Product : comments on >

' ML Domain relationships
RecommendationService "1" --> "1" RecommendationEngine : uses >
RecommendationEngine "1" --> "1..*" RecommendationModel : uses >
RecommendationModel <|-- ENCM
RecommendationModel <|-- LNCM
RecommendationModel <|-- NeuMF
RecommendationModel <|-- BMF
RecommendationService --> User : generates_for
RecommendationService --> Product : recommends
RecommendationService --> Recommendation : creates

' StatisticService relationships
StatisticService ..> OrderProduct : queries >
StatisticService ..> Product : queries >
StatisticService ..> User : queries >
StatisticService ..> Comment : queries >
StatisticService ..> ReceiptDetail : queries >

' ============================================
' AGGREGATION & COMPOSITION
' ============================================
OrderProduct *-- "1..*" OrderDetail : contains
Receipt *-- "1..*" ReceiptDetail : contains
ProductDetail *-- "0..*" ProductDetailSize : contains
ProductDetail *-- "0..*" ProductImage : contains

@enduml

